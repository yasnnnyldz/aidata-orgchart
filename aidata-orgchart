<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AIDATA Organizasyon Şeması</title>
<link rel="icon" href="AIDATA LOGO.ico" type="image/ico">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg: #0f172a;
  --panel: #1e293b;
  --card-bg: #1e293b;
  --card-border:#94a3b8;
  --text-color: #f1f5f9;
  --muted:#94a3b8;
  --badge-bg:#334155;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bg);color:var(--text-color);min-height:100vh;display:flex;flex-direction:column}
header{padding:12px 16px;background:#0b1223;color:#fff;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;}
.header-left{display:flex;align-items:center;gap:8px;min-width:0;}
header h1{margin:0;font-size:16px;display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.wrap{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
.panel{background:var(--card-bg);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input[type=text], select{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;margin-bottom:10px;background:var(--bg);color:var(--text-color)}
.checkbox-container{max-height:150px;overflow:auto;border:1px solid #334155;padding:6px;border-radius:8px;margin-bottom:10px;background:var(--bg)}
.checkbox-container label{display:block;font-size:12px;margin-bottom:4px;cursor:pointer;color:var(--text-color)}
.btn{display:inline-block;padding:8px 10px;border-radius:8px;border:0;background:#0ea5e9;color:white;cursor:pointer;font-weight:600;margin-right:6px}
.btn.secondary{background:#334155;color:#f1f5f9}
.btn.danger{background:#ef4444}
.canvas{background:var(--bg);border-radius:10px;padding:18px;overflow:auto;min-height:520px}
.tree{display:flex;justify-content:center;align-items:flex-start;gap:80px;flex-wrap:wrap}
.node{background:var(--card-bg);border-radius:12px;padding:10px 12px;min-width:160px;max-width:220px;text-align:center;border:2px solid var(--card-border);box-shadow:0 6px 18px rgba(2,6,23,.06); color:var(--text-color); cursor:pointer;position:relative}
.node.root{background:#0ea5e9;color:white;border-color:#0284c7;}
.node .name{font-weight:700;margin-bottom:6px}
.node .title{font-size:12px;margin-bottom:6px}
.node .cities{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-bottom:6px}
.city-badge{background:var(--badge-bg);padding:2px 6px;border-radius:6px;font-size:11px;}
.children{display:flex;gap:18px;justify-content:center;margin-top:18px}
.children.column{flex-direction:column;align-items:center}
.connector{width:2px;height:18px;background:linear-gradient(180deg,#64748b,#475569);margin:0 auto}
.toggle-btn{font-size:10px;padding:2px 6px;margin-top:4px;border-radius:4px;border:none;background:#0ea5e9;color:#fff;cursor:pointer;}
.small{font-size:12px;color:var(--muted)}
@media (max-width:880px){ 
  .wrap{grid-template-columns:1fr} 
  .header-left, .header-right{width:100%;justify-content:center;margin-bottom:6px;}
}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <img src="https://media.licdn.com/dms/image/v2/D4D0BAQFgTauECc2bmw/company-logo_200_200/company-logo_200_200/0/1722344758736/aidatabilisim_logo?e=2147483647&v=beta&t=JCh778W4XZUqdLymtE1w4QlwHm8YumazICg-riQNi5k" alt="AIDATA Logo" style="width:40px;height:40px;border-radius:6px;">
    <h1>AIDATA Organizasyon Şeması</h1>
  </div>
  <div class="header-right">
    <button id="exportPDF" class="btn">PDF Olarak İndir</button>
    <button id="exportJSON" class="btn secondary">JSON Olarak Dışa Aktar</button>
    <input type="file" id="importJSON" style="display:none">
    <button id="btnImportJSON" class="btn secondary">JSON Yükle</button>
    <button id="btnResetHeader" class="btn danger">Verileri Sıfırla</button>
  </div>
</header>

<div class="wrap">
  <aside class="panel" style="min-height:520px">
    <h3 style="margin:0 0 10px">Kişi Ekle / Güncelle</h3>
    <label>Ad Soyad</label>
    <input type="text" id="inpName" placeholder="Örn. Ahmet Yılmaz">
    <label>Ünvan (opsiyonel)</label>
    <input type="text" id="inpTitle" placeholder="Örn. Ekip Lideri">
    <label>Kök Bölüm</label>
    <select id="inpRoot">
      <option value="AIDATA Organizasyon Şeması">AIDATA Organizasyon Şeması</option>
    </select>
    <label>Bağlı Olduğu Kişi</label>
    <select id="inpParent"><option value="">— (üst yok / seçilen kökün altına)</option></select>
    <label>Sorumlu Olduğu İller</label>
    <input type="text" id="citySearch" placeholder="İl ara..." style="margin-bottom:6px;padding:6px;border-radius:6px;border:1px solid #334155;width:100%">
    <div class="checkbox-container" id="cityCheckboxes"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button id="btnAdd" class="btn">Ekle</button>
      <button id="btnUpdate" class="btn" style="display:none">Güncelle</button>
      <button id="btnDelete" class="btn danger" style="display:none">Seçili Kişiyi Sil</button>
      <button id="btnClear" class="btn secondary">Formu Temizle</button>
    </div>
  </aside>

  <main class="canvas panel">
    <div id="canvasInner">
      <div id="treeRoot" style="min-height:440px;display:flex;flex-direction:column;align-items:center;gap:18px">
        <div style="color:var(--muted);">Henüz kişi yok — sol panelden bir kişi ekleyin</div>
      </div>
    </div>
  </main>
</div>

<script>
const STORAGE_KEY = 'orgchart.v3';
const uid = ()=> 'n_' + Math.random().toString(36).slice(2,9);
let nodes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]').map(n => ({...n, expanded:false}));
let editingId = null;

const inpName = document.getElementById('inpName');
const inpTitle = document.getElementById('inpTitle');
const inpParent = document.getElementById('inpParent');
const inpRoot = document.getElementById('inpRoot');
const cityCheckboxes = document.getElementById('cityCheckboxes');
const treeRoot = document.getElementById('treeRoot');
const btnAdd = document.getElementById('btnAdd');
const btnUpdate = document.getElementById('btnUpdate');
const btnDelete = document.getElementById('btnDelete');
const btnClear = document.getElementById('btnClear');
const btnResetHeader = document.getElementById('btnResetHeader');
const exportPDF = document.getElementById('exportPDF');
const exportJSON = document.getElementById('exportJSON');
const importJSON = document.getElementById('importJSON');
const btnImportJSON = document.getElementById('btnImportJSON');
const citySearch = document.getElementById('citySearch');

const cities = ["Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya",
"Ardahan","Artvin","Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur",
"Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Elazığ","Erzincan","Erzurum","Eskişehir","Gaziantep",
"Giresun","Gümüşhane","Hakkari","Hatay","Iğdır","Isparta","İstanbul","İzmir","Kahramanmaraş","Karabük","Karaman",
"Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir","Kilis","Konya","Kütahya","Malatya","Manisa",
"Mardin","Muğla","Muş","Nevşehir","Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas",
"Şanlıurfa","Şırnak","Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"];

function initCityCheckboxes(filter=''){
  cityCheckboxes.innerHTML = '';
  cities.filter(c=>c.toLowerCase().includes(filter.toLowerCase())).forEach(city=>{
    const label = document.createElement('label');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.value=city;
    label.appendChild(cb); label.appendChild(document.createTextNode(' ' + city));
    cityCheckboxes.appendChild(label);
  });
}
citySearch.addEventListener('input', ()=> initCityCheckboxes(citySearch.value));

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(nodes)); }
function clearForm(){ 
  inpName.value=''; inpTitle.value=''; inpParent.value=''; 
  Array.from(cityCheckboxes.querySelectorAll('input')).forEach(cb=>cb.checked=false); 
  editingId=null; 
  btnAdd.style.display='inline-block'; 
  btnUpdate.style.display='none'; 
  btnDelete.style.display='none';
}

function buildOptions(){
  inpParent.innerHTML = '<option value="">— (üst yok / kök seç)</option>';
  nodes
    .filter(n => n.expanded && (n.title || '').toLowerCase() !== 'sorumlu teknisyen' && (n.title || '').toLowerCase() !== 'operasyon uzman yardımcısı')
    .forEach(n=>{
      const opt = document.createElement('option'); 
      opt.value = n.id; 
      opt.textContent = n.name + (n.title? ' — ' + n.title : '');
      inpParent.appendChild(opt);
    });
}

function findChildren(id){ return nodes.filter(n=>n.parentId===id).sort((a,b)=>a.name.localeCompare(b.name,'tr')); }

function render(){ 
  buildOptions();
  treeRoot.innerHTML = '';
  const container = document.createElement('div');
  container.className = 'tree';
  const rootNode = document.createElement('div');
  rootNode.style.display='flex'; rootNode.style.flexDirection='column'; rootNode.style.alignItems='center';
  const rootCard = document.createElement('div'); 
  rootCard.className='node root'; 
  rootCard.textContent = 'AIDATA Organizasyon Şeması';
  rootNode.appendChild(rootCard);
  const children = nodes.filter(n=>!n.parentId);
  if(children.length){
    const col = document.createElement('div'); col.className='children';
    children.forEach(ch => col.appendChild(renderNodeRec(ch)));
    rootNode.appendChild(col);
  }
  container.appendChild(rootNode);
  treeRoot.appendChild(container);
}

function renderNodeRec(node){
  const wrapper = document.createElement('div');
  wrapper.style.display='flex'; wrapper.style.flexDirection='column'; wrapper.style.alignItems='center'; wrapper.style.gap='6px';
  const card = document.createElement('div'); card.className='node';
  const nm = document.createElement('div'); nm.className='name'; nm.textContent = node.name;
  const tl = document.createElement('div'); tl.className='title'; tl.textContent = node.title || '';
  const cityDiv = document.createElement('div'); cityDiv.className='cities';
  if(node.cities) node.cities.forEach(c=>{
    const span = document.createElement('span'); span.className='city-badge'; span.textContent=c; cityDiv.appendChild(span);
  });
  card.appendChild(nm); card.appendChild(tl); card.appendChild(cityDiv);

  card.addEventListener('click', ()=>{
    editingId = node.id;
    inpName.value = node.name;
    inpTitle.value = node.title || '';
    inpParent.value = node.parentId || '';
    inpRoot.value = 'AIDATA Organizasyon Şeması';
    Array.from(cityCheckboxes.querySelectorAll('input')).forEach(cb=>cb.checked=node.cities?.includes(cb.value));
    btnAdd.style.display='none'; 
    btnUpdate.style.display='inline-block';
    btnDelete.style.display='inline-block';
  });

  const children = findChildren(node.id);
  const childrenWrapper = document.createElement('div');
  childrenWrapper.style.display = node.expanded ? 'flex' : 'none';
  childrenWrapper.style.flexDirection='column';
  childrenWrapper.style.alignItems='center';
  childrenWrapper.style.gap = '6px';

  if(children.length){
    const toggleBtn = document.createElement('button');
    toggleBtn.className='toggle-btn';
    toggleBtn.textContent = node.expanded ? 'Daralt' : 'Genişlet';
    toggleBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      node.expanded = !node.expanded;
      childrenWrapper.style.display = node.expanded ? 'flex' : 'none';
      toggleBtn.textContent = node.expanded ? 'Daralt' : 'Genişlet';
      buildOptions();
      save();
    });
    card.appendChild(toggleBtn);
  }

  const opUzman = children.filter(ch=> (ch.title || '').toLowerCase() === 'operasyon uzman yardımcısı'.toLowerCase());
  const teknisyen = children.filter(ch=> (ch.title || '').toLowerCase() === 'sorumlu teknisyen'.toLowerCase());
  const diger = children.filter(ch=> (ch.title || '').toLowerCase() !== 'operasyon uzman yardımcısı'.toLowerCase() && (ch.title || '').toLowerCase() !== 'sorumlu teknisyen'.toLowerCase());

  if(diger.length){
    const col = document.createElement('div'); col.className='children';
    diger.forEach(ch => col.appendChild(renderNodeRec(ch)));
    childrenWrapper.appendChild(col);
  }
  if(opUzman.length){
    const colOp = document.createElement('div'); colOp.className='children column';
    opUzman.forEach(ch => colOp.appendChild(renderNodeRec(ch)));
    childrenWrapper.appendChild(colOp);
  }
  if(teknisyen.length){
    const colTech = document.createElement('div'); colTech.className='children column';
    teknisyen.forEach(ch => colTech.appendChild(renderNodeRec(ch)));
    childrenWrapper.appendChild(colTech);
  }

  wrapper.appendChild(card);
  wrapper.appendChild(childrenWrapper);
  return wrapper;
}

// Eventlar
btnAdd.addEventListener('click', ()=>{
  const name = inpName.value.trim(); if(!name) return alert('İsim gerekli');
  const id = uid();
  const citiesSelected = Array.from(cityCheckboxes.querySelectorAll('input:checked')).map(cb=>cb.value);
  nodes.push({id,name,title:inpTitle.value.trim(),parentId:inpParent.value||null,cities:citiesSelected,expanded:false});
  save(); clearForm(); render();
});
btnUpdate.addEventListener('click', ()=>{
  if(!editingId) return;
  const node = nodes.find(n=>n.id===editingId); if(!node) return;
  node.name = inpName.value.trim(); node.title = inpTitle.value.trim();
  node.parentId = inpParent.value||null;
  node.cities = Array.from(cityCheckboxes.querySelectorAll('input:checked')).map(cb=>cb.value);
  save(); clearForm(); render();
});
btnDelete.addEventListener('click', ()=>{
  if(!editingId) return;
  nodes = nodes.filter(n=>n.id!==editingId && n.parentId!==editingId);
  save(); clearForm(); render();
});
btnClear.addEventListener('click', clearForm);
btnResetHeader.addEventListener('click', ()=>{if(confirm('Tüm veriler silinecek?')){nodes=[];save();render();clearForm();}});

exportPDF.addEventListener('click', () => {
  html2canvas(treeRoot, { scale: 4, backgroundColor: null }).then(canvas => {
    const img = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('landscape', 'mm', 'a3'); // A3 yatay

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 20;

    const logoUrl = "https://media.licdn.com/dms/image/v2/D4D0BAQFgTauECc2bmw/company-logo_200_200/company-logo_200_200/0/1722344758736/aidatabilisim_logo?e=2147483647&v=beta&t=JCh778W4XZUqdLymtE1w4QlwHm8YumazICg-riQNi5k";
    const logoSize = 6;
    pdf.addImage(logoUrl, 'PNG', margin, 5, logoSize, logoSize);
    pdf.setFontSize(10);
    pdf.text("AIDATA ORGANIZASYON SEMASI", margin + logoSize + 3, 10);

    const availableWidth = pageWidth - margin * 2;
    const availableHeight = pageHeight - 40;
    const imgWidth = availableWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    const finalHeight = imgHeight > availableHeight ? availableHeight : imgHeight;

    pdf.addImage(img, 'PNG', margin, 35, imgWidth, finalHeight);
    pdf.save('aidata-organizasyon-semasi-a3.pdf');
  });
});

exportJSON.addEventListener('click', ()=>{
  const dataStr = JSON.stringify(nodes,null,2);
  const blob = new Blob([dataStr],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='organizasyon.json'; a.click();
  URL.revokeObjectURL(url);
});

btnImportJSON.addEventListener('click', ()=> importJSON.click());
importJSON.addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      nodes = JSON.parse(reader.result).map(n => ({...n, expanded:false}));
      save(); render();
    }catch(err){alert('Geçersiz JSON');}
  };
  reader.readAsText(file);
});

initCityCheckboxes();
render();
</script>
</body>
</html>
